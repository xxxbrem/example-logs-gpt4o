2025-05-07 00:46:11 - Thread-3174 (execute) - INFO - itercount: 0
2025-05-07 00:46:11 - Thread-3174 (execute) - INFO - [Self-refine]
Table full name: E_COMMERCE.E_COMMERCE.LEADS_QUALIFIED
Column name: first_contact_date Type: TEXT
Column name: origin Type: TEXT
Column name: landing_page_id Type: TEXT
Column name: mql_id Type: TEXT
Sample rows:
[{'mql_id': 'dac32acd4db4c29c230538b72f8dd87d', 'first_contact_date': '2018-02-01', 'landing_page_id': '88740e65d5d6b056e0cda098e1ea6313', 'origin': 'social'}, {'mql_id': 'b4bc852d233dfefc5131f593b538befa', 'first_contact_date': '2018-03-22', 'landing_page_id': 'a7982125ff7aa3b2054c6e44f9d28522', 'origin': 'organic_search'}, {'mql_id': '28bdfd5f057764b54c38770f95c69f2f', 'first_contact_date': '2018-01-14', 'landing_page_id': '22c29808c4f815213303f8933030604c', 'origin': 'organic_search'}, {'mql_id': '126a0d10becbaafcb2e72ce6848cf32c', 'first_contact_date': '2018-05-15', 'landing_page_id': '6a110e795dd487f1cf8d7583671987af', 'origin': 'email'}, {'mql_id': 'f76136f54d14a3345951f25b7932366b', 'first_contact_date': '2018-05-24', 'landing_page_id': 'd51b0d02f063ba1d053db6d97226eec3', 'origin': 'email'}]

--------------------------------------------------
Table full name: E_COMMERCE.E_COMMERCE.GEOLOCATION
Column name: geolocation_zip_code_prefix Type: NUMBER
Column name: geolocation_city Type: TEXT
Column name: geolocation_lng Type: FLOAT
Column name: geolocation_state Type: TEXT
Column name: geolocation_lat Type: FLOAT
Sample rows:
[{'geolocation_zip_code_prefix': 47940, 'geolocation_lat': -12.118520396156198, 'geolocation_lng': -43.89223348300082, 'geolocation_city': 'wanderley', 'geolocation_state': 'BA'}, {'geolocation_zip_code_prefix': 47990, 'geolocation_lat': -11.043509645586902, 'geolocation_lng': -45.18667845319278, 'geolocation_city': 'formosa do rio preto', 'geolocation_state': 'BA'}, {'geolocation_zip_code_prefix': 47990, 'geolocation_lat': -11.03457140262401, 'geolocation_lng': -45.18776655510399, 'geolocation_city': 'formosa do rio preto', 'geolocation_state': 'BA'}, {'geolocation_zip_code_prefix': 47990, 'geolocation_lat': -11.04186115496844, 'geolocation_lng': -45.18988326259359, 'geolocation_city': 'formosa do rio preto', 'geolocation_state': 'BA'}, {'geolocation_zip_code_prefix': 47940, 'geolocation_lat': -12.123543963024664, 'geolocation_lng': -43.891740814417616, 'geolocation_city': 'wanderley', 'geolocation_state': 'BA'}]

--------------------------------------------------
Table full name: E_COMMERCE.E_COMMERCE.LEADS_CLOSED
Column name: business_type Type: TEXT
Column name: has_gtin Type: FLOAT
Column name: average_stock Type: TEXT
Column name: won_date Type: TEXT
Column name: lead_type Type: TEXT
Column name: lead_behaviour_profile Type: TEXT
Column name: has_company Type: FLOAT
Column name: declared_monthly_revenue Type: FLOAT
Column name: seller_id Type: TEXT
Column name: sr_id Type: TEXT
Column name: business_segment Type: TEXT
Column name: sdr_id Type: TEXT
Column name: mql_id Type: TEXT
Column name: declared_product_catalog_size Type: FLOAT
Sample rows:
[{'mql_id': '5420aad7fec3549a85876ba1c529bd84', 'seller_id': '2c43fb513632d29b3b58df74816f1b06', 'sdr_id': 'a8387c01a09e99ce014107505b92388c', 'sr_id': '4ef15afb4b2723d8f3d81e51ec7afefe', 'won_date': '2018-02-26 19:58:54', 'business_segment': 'pet', 'lead_type': 'online_medium', 'lead_behaviour_profile': 'cat', 'has_company': None, 'has_gtin': None, 'average_stock': '', 'business_type': 'reseller', 'declared_product_catalog_size': None, 'declared_monthly_revenue': 0.0}, {'mql_id': 'ffe640179b554e295c167a2f6be528e0', 'seller_id': 'ed8cb7b190ceb6067227478e48cf8dde', 'sdr_id': '4b339f9567d060bcea4f5136b9f5949e', 'sr_id': 'd3d1e91a157ea7f90548eef82f1955e3', 'won_date': '2018-07-03 20:17:45', 'business_segment': 'home_appliances', 'lead_type': 'industry', 'lead_behaviour_profile': 'wolf', 'has_company': None, 'has_gtin': None, 'average_stock': '', 'business_type': 'manufacturer', 'declared_product_catalog_size': None, 'declared_monthly_revenue': 0.0}, {'mql_id': 'b94fba7670eeb44dce2a0d8eb790e9f5', 'seller_id': '1c742ac33582852aaf3bcfbf5893abcf', 'sdr_id': 'fdb16d3cbbeb5798f2f66c4096be026d', 'sr_id': '495d4e95a8cf8bbf8b432b612a2aa328', 'won_date': '2018-02-07 18:04:05', 'business_segment': 'health_beauty', 'lead_type': 'online_medium', 'lead_behaviour_profile': '', 'has_company': None, 'has_gtin': None, 'average_stock': '', 'business_type': 'manufacturer', 'declared_product_catalog_size': None, 'declared_monthly_revenue': 0.0}, {'mql_id': 'a90a37898cc5f2718385a2fb981caaff', 'seller_id': '0b28859cd04d23edefee9c591fb03cd8', 'sdr_id': 'f42a2bd194f7802ab052a815c8de65b7', 'sr_id': '6565aa9ce3178a5caf6171827af3a9ba', 'won_date': '2018-05-14 18:37:15', 'business_segment': 'household_utilities', 'lead_type': 'offline', 'lead_behaviour_profile': 'eagle', 'has_company': None, 'has_gtin': None, 'average_stock': '', 'business_type': 'reseller', 'declared_product_catalog_size': None, 'declared_monthly_revenue': 0.0}, {'mql_id': '0173e8d8b1d94a355b440fb67388f532', 'seller_id': '87d73636a3acf123e842bb890a4db036', 'sdr_id': '9d12ef1a7eca3ec58c545c678af7869c', 'sr_id': '9e4d1098a3b0f5da39b0bc48f9876645', 'won_date': '2018-04-24 03:00:00', 'business_segment': 'household_utilities', 'lead_type': 'online_medium', 'lead_behaviour_profile': 'eagle', 'has_company': None, 'has_gtin': None, 'average_stock': '', 'business_type': 'manufacturer', 'declared_product_catalog_size': None, 'declared_monthly_revenue': 0.0}]

--------------------------------------------------
Table full name: E_COMMERCE.E_COMMERCE.ORDER_ITEMS
Column name: order_id Type: TEXT
Column name: price Type: FLOAT
Column name: order_item_id Type: NUMBER
Column name: shipping_limit_date Type: TEXT
Column name: product_id Type: TEXT
Column name: seller_id Type: TEXT
Column name: freight_value Type: FLOAT
Sample rows:
[{'order_id': '00010242fe8c5a6d1ba2dd792cb16214', 'order_item_id': 1, 'product_id': '4244733e06e7ecb4970a6e2683c13e61', 'seller_id': '48436dade18ac8b2bce089ec2a041202', 'shipping_limit_date': '2017-09-19 09:45:35', 'price': 58.9, 'freight_value': 13.29}, {'order_id': '00024acbcdf0a6daa1e931b038114c75', 'order_item_id': 1, 'product_id': '7634da152a4610f1595efa32f14722fc', 'seller_id': '9d7a1d34a5052409006425275ba1c2b4', 'shipping_limit_date': '2018-08-15 10:10:18', 'price': 12.99, 'freight_value': 12.79}, {'order_id': '00042b26cf59d7ce69dfabb4e55b4fd9', 'order_item_id': 1, 'product_id': 'ac6c3623068f30de03045865e4e10089', 'seller_id': 'df560393f3a51e74553ab94004ba5c87', 'shipping_limit_date': '2017-02-13 13:57:51', 'price': 199.9, 'freight_value': 18.14}, {'order_id': '00048cc3ae777c65dbb7d2a0634bc1ea', 'order_item_id': 1, 'product_id': 'ef92defde845ab8450f9d70c526ef70f', 'seller_id': '6426d21aca402a131fc0a5d0960a3c90', 'shipping_limit_date': '2017-05-23 03:55:27', 'price': 21.9, 'freight_value': 12.69}, {'order_id': '00054e8431b9d7675808bcb819fb4a32', 'order_item_id': 1, 'product_id': '8d4f2bb7e93e6710a28f34fa83ee7d28', 'seller_id': '7040e82f899a04d1b434b795a43b4617', 'shipping_limit_date': '2017-12-14 12:10:31', 'price': 19.9, 'freight_value': 11.85}]

--------------------------------------------------
Table full name: E_COMMERCE.E_COMMERCE.SELLERS
Column name: seller_zip_code_prefix Type: NUMBER
Column name: seller_state Type: TEXT
Column name: seller_city Type: TEXT
Column name: seller_id Type: TEXT
Sample rows:
[{'seller_id': '3442f8959a84dea7ee197c632cb2df15', 'seller_zip_code_prefix': 13023, 'seller_city': 'campinas', 'seller_state': 'SP'}, {'seller_id': 'd1b65fc7debc3361ea86b5f14c68d2e2', 'seller_zip_code_prefix': 13844, 'seller_city': 'mogi guacu', 'seller_state': 'SP'}, {'seller_id': 'ce3ad9de960102d0677a81f5d0bb7b2d', 'seller_zip_code_prefix': 20031, 'seller_city': 'rio de janeiro', 'seller_state': 'RJ'}, {'seller_id': '51a04a8a6bdcb23deccc82b0b80742cf', 'seller_zip_code_prefix': 12914, 'seller_city': 'braganca paulista', 'seller_state': 'SP'}, {'seller_id': 'e49c26c3edfa46d227d5121a6b6e4d37', 'seller_zip_code_prefix': 55325, 'seller_city': 'brejao', 'seller_state': 'PE'}]

--------------------------------------------------
Table full name: E_COMMERCE.E_COMMERCE.CUSTOMERS
Column name: customer_city Type: TEXT
Column name: customer_state Type: TEXT
Column name: customer_id Type: TEXT
Column name: customer_zip_code_prefix Type: NUMBER
Column name: customer_unique_id Type: TEXT
Sample rows:
[{'customer_id': 'b2b6027bc5c5109e529d4dc6358b12c3', 'customer_unique_id': '259dac757896d24d7702b9acbbff3f3c', 'customer_zip_code_prefix': 8775, 'customer_city': 'mogi das cruzes', 'customer_state': 'SP'}, {'customer_id': '5e274e7a0c3809e14aba7ad5aae0d407', 'customer_unique_id': '57b2a98a409812fe9618067b6b8ebe4f', 'customer_zip_code_prefix': 35182, 'customer_city': 'timoteo', 'customer_state': 'MG'}, {'customer_id': 'eabebad39a88bb6f5b52376faec28612', 'customer_unique_id': '295c05e81917928d76245e842748184d', 'customer_zip_code_prefix': 5704, 'customer_city': 'sao paulo', 'customer_state': 'SP'}, {'customer_id': 'a7c125a0a07b75146167b7f04a7f8e98', 'customer_unique_id': '5c2991dbd08bbf3cf410713c4de5a0b5', 'customer_zip_code_prefix': 22750, 'customer_city': 'rio de janeiro', 'customer_state': 'RJ'}, {'customer_id': '9b8ce803689b3562defaad4613ef426f', 'customer_unique_id': '7f3a72e8f988c6e735ba118d54f47458', 'customer_zip_code_prefix': 5416, 'customer_city': 'sao paulo', 'customer_state': 'SP'}]

--------------------------------------------------
Table full name: E_COMMERCE.E_COMMERCE.ORDER_REVIEWS
Column name: review_comment_title Type: TEXT
Column name: review_answer_timestamp Type: TEXT
Column name: review_score Type: NUMBER
Column name: order_id Type: TEXT
Column name: review_id Type: TEXT
Column name: review_creation_date Type: TEXT
Column name: review_comment_message Type: TEXT
Sample rows:
[{'review_id': '7bc2406110b926393aa56f80a40eba40', 'order_id': '73fc7af87114b39712e6da79b0a377eb', 'review_score': 4, 'review_comment_title': '', 'review_comment_message': '', 'review_creation_date': '2018-01-18 00:00:00', 'review_answer_timestamp': '2018-01-18 21:46:59'}, {'review_id': '80e641a11e56f04c1ad469d5645fdfde', 'order_id': 'a548910a1c6147796b98fdf73dbeba33', 'review_score': 5, 'review_comment_title': '', 'review_comment_message': '', 'review_creation_date': '2018-03-10 00:00:00', 'review_answer_timestamp': '2018-03-11 03:05:13'}, {'review_id': 'e64fb393e7b32834bb789ff8bb30750e', 'order_id': '658677c97b385a9be170737859d3511b', 'review_score': 5, 'review_comment_title': '', 'review_comment_message': 'Recebi bem antes do prazo estipulado.', 'review_creation_date': '2017-04-21 00:00:00', 'review_answer_timestamp': '2017-04-21 22:02:06'}, {'review_id': '07f9bee5d1b850860defd761afa7ff16', 'order_id': 'e48aa0d2dcec3a2e87348811bcfdf22b', 'review_score': 5, 'review_comment_title': '', 'review_comment_message': '', 'review_creation_date': '2017-07-16 00:00:00', 'review_answer_timestamp': '2017-07-18 19:30:34'}, {'review_id': '23f75a37effc35d9a915b4e1ad483793', 'order_id': '2eaf8e099d871cd5c22b83b5ea8f6e0e', 'review_score': 4, 'review_comment_title': '', 'review_comment_message': '', 'review_creation_date': '2018-03-28 00:00:00', 'review_answer_timestamp': '2018-03-30 15:10:55'}]

--------------------------------------------------
Table full name: E_COMMERCE.E_COMMERCE.PRODUCTS
Column name: product_photos_qty Type: FLOAT
Column name: product_description_lenght Type: FLOAT
Column name: product_height_cm Type: FLOAT
Column name: product_width_cm Type: FLOAT
Column name: product_name_lenght Type: FLOAT
Column name: product_id Type: TEXT
Column name: product_weight_g Type: FLOAT
Column name: product_length_cm Type: FLOAT
Column name: product_category_name Type: TEXT
Sample rows:
[{'product_id': '96bd76ec8810374ed1b65e291975717f', 'product_category_name': 'esporte_lazer', 'product_name_lenght': 46.0, 'product_description_lenght': 250.0, 'product_photos_qty': 1.0, 'product_weight_g': 154.0, 'product_length_cm': 18.0, 'product_height_cm': 9.0, 'product_width_cm': 15.0}, {'product_id': 'cef67bcfe19066a932b7673e239eb23d', 'product_category_name': 'bebes', 'product_name_lenght': 27.0, 'product_description_lenght': 261.0, 'product_photos_qty': 1.0, 'product_weight_g': 371.0, 'product_length_cm': 26.0, 'product_height_cm': 4.0, 'product_width_cm': 26.0}, {'product_id': '9dc1a7de274444849c219cff195d0b71', 'product_category_name': 'utilidades_domesticas', 'product_name_lenght': 37.0, 'product_description_lenght': 402.0, 'product_photos_qty': 4.0, 'product_weight_g': 625.0, 'product_length_cm': 20.0, 'product_height_cm': 17.0, 'product_width_cm': 13.0}, {'product_id': '732bd381ad09e530fe0a5f457d81becb', 'product_category_name': 'cool_stuff', 'product_name_lenght': 56.0, 'product_description_lenght': 1272.0, 'product_photos_qty': 4.0, 'product_weight_g': 18350.0, 'product_length_cm': 70.0, 'product_height_cm': 24.0, 'product_width_cm': 44.0}, {'product_id': '2548af3e6e77a690cf3eb6368e9ab61e', 'product_category_name': 'moveis_decoracao', 'product_name_lenght': 56.0, 'product_description_lenght': 184.0, 'product_photos_qty': 2.0, 'product_weight_g': 900.0, 'product_length_cm': 40.0, 'product_height_cm': 8.0, 'product_width_cm': 40.0}]

--------------------------------------------------
Table full name: E_COMMERCE.E_COMMERCE.PRODUCT_CATEGORY_NAME_TRANSLATION
Column name: product_category_name Type: TEXT
Column name: product_category_name_english Type: TEXT
Sample rows:
[{'product_category_name': 'informatica_acessorios', 'product_category_name_english': 'computers_accessories'}, {'product_category_name': 'moveis_decoracao', 'product_category_name_english': 'furniture_decor'}, {'product_category_name': 'esporte_lazer', 'product_category_name_english': 'sports_leisure'}, {'product_category_name': 'relogios_presentes', 'product_category_name_english': 'watches_gifts'}, {'product_category_name': 'alimentos_bebidas', 'product_category_name_english': 'food_drink'}]

--------------------------------------------------
Table full name: E_COMMERCE.E_COMMERCE.ORDERS
Column name: order_delivered_customer_date Type: TEXT
Column name: order_status Type: TEXT
Column name: order_id Type: TEXT
Column name: order_delivered_carrier_date Type: TEXT
Column name: order_purchase_timestamp Type: TEXT
Column name: order_estimated_delivery_date Type: TEXT
Column name: order_approved_at Type: TEXT
Column name: customer_id Type: TEXT
Sample rows:
[{'order_id': 'e481f51cbdc54678b7cc49136f2d6af7', 'customer_id': '9ef432eb6251297304e76186b10a928d', 'order_status': 'delivered', 'order_purchase_timestamp': '2017-10-02 10:56:33', 'order_approved_at': '2017-10-02 11:07:15', 'order_delivered_carrier_date': '2017-10-04 19:55:00', 'order_delivered_customer_date': '2017-10-10 21:25:13', 'order_estimated_delivery_date': '2017-10-18 00:00:00'}, {'order_id': '53cdb2fc8bc7dce0b6741e2150273451', 'customer_id': 'b0830fb4747a6c6d20dea0b8c802d7ef', 'order_status': 'delivered', 'order_purchase_timestamp': '2018-07-24 20:41:37', 'order_approved_at': '2018-07-26 03:24:27', 'order_delivered_carrier_date': '2018-07-26 14:31:00', 'order_delivered_customer_date': '2018-08-07 15:27:45', 'order_estimated_delivery_date': '2018-08-13 00:00:00'}, {'order_id': '949d5b44dbf5de918fe9c16f97b45f8a', 'customer_id': 'f88197465ea7920adcdbec7375364d82', 'order_status': 'delivered', 'order_purchase_timestamp': '2017-11-18 19:28:06', 'order_approved_at': '2017-11-18 19:45:59', 'order_delivered_carrier_date': '2017-11-22 13:39:59', 'order_delivered_customer_date': '2017-12-02 00:28:42', 'order_estimated_delivery_date': '2017-12-15 00:00:00'}, {'order_id': '6514b8ad8028c9f2cc2374ded245783f', 'customer_id': '9bdf08b4b3b52b5526ff42d37d47f222', 'order_status': 'delivered', 'order_purchase_timestamp': '2017-05-16 13:10:30', 'order_approved_at': '2017-05-16 13:22:11', 'order_delivered_carrier_date': '2017-05-22 10:07:46', 'order_delivered_customer_date': '2017-05-26 12:55:51', 'order_estimated_delivery_date': '2017-06-07 00:00:00'}, {'order_id': '76c6e866289321a7c93b82b54852dc33', 'customer_id': 'f54a9f0e6b351c431402b8461ea51999', 'order_status': 'delivered', 'order_purchase_timestamp': '2017-01-23 18:29:09', 'order_approved_at': '2017-01-25 02:50:47', 'order_delivered_carrier_date': '2017-01-26 14:16:31', 'order_delivered_customer_date': '2017-02-02 14:08:10', 'order_estimated_delivery_date': '2017-03-06 00:00:00'}]

--------------------------------------------------
Table full name: E_COMMERCE.E_COMMERCE.ORDER_PAYMENTS
Column name: payment_sequential Type: NUMBER
Column name: payment_installments Type: NUMBER
Column name: payment_value Type: FLOAT
Column name: order_id Type: TEXT
Column name: payment_type Type: TEXT
Sample rows:
[{'order_id': 'b81ef226f3fe1789b1e8b2acac839d17', 'payment_sequential': 1, 'payment_type': 'credit_card', 'payment_installments': 8, 'payment_value': 99.33}, {'order_id': 'a9810da82917af2d9aefd1278f1dcfa0', 'payment_sequential': 1, 'payment_type': 'credit_card', 'payment_installments': 1, 'payment_value': 24.39}, {'order_id': '25e8ea4e93396b6fa0d3dd708e76c1bd', 'payment_sequential': 1, 'payment_type': 'credit_card', 'payment_installments': 1, 'payment_value': 65.71}, {'order_id': '42fdf880ba16b47b59251dd489d4441a', 'payment_sequential': 1, 'payment_type': 'credit_card', 'payment_installments': 2, 'payment_value': 128.45}, {'order_id': '1f78449c87a54faf9e96e88ba1491fa9', 'payment_sequential': 1, 'payment_type': 'credit_card', 'payment_installments': 6, 'payment_value': 341.09}]

--------------------------------------------------
External knowledge that might be helpful: 
None
The table structure information is ({database name: {schema name: [table name]}}): 
{'E_COMMERCE': {'E_COMMERCE': ['LEADS_QUALIFIED', 'GEOLOCATION', 'LEADS_CLOSED', 'ORDER_ITEMS', 'SELLERS', 'CUSTOMERS', 'ORDER_REVIEWS', 'PRODUCTS', 'PRODUCT_CATEGORY_NAME_TRANSLATION', 'ORDERS', 'ORDER_PAYMENTS']}}
Task: Could you tell me the number of orders, average payment per order and customer lifespan in weeks of the 3 custumers with the highest average payment per order, where the lifespan is calculated by subtracting the earliest purchase date from the latest purchase date in days, dividing by seven, and if the result is less than seven days, setting it to 1.0?

Please think step by step and answer only one complete SQL in snowflake dialect in ```sql``` format.
SQL usage example: ```sql
SELECT "COLUMN_NAME" FROM DATABASE.SCHEMA.TABLE WHERE ... ``` (Adjust "DATABASE", "SCHEMA", and "TABLE" to match actual names, ensure all column names are enclosed in double quotations)
Here are some useful tips for answering:
When performing a UNION operation on many tables, ensure that all table names are explicitly listed. Union first and then add condition and selection. e.g. SELECT "col1", "col2" FROM (TABLE1 UNION ALL TABLE2) WHERE ...; Don't write sqls as (SELECT col1, col2 FROM TABLE1 WHERE ...) UNION ALL (SELECT col1, col2 FROM TABLE2 WHERE ...); Don't use ['-- Include all', '-- Omit', '-- Continue', '-- Union all', '-- ...', '-- List all', '-- Replace this', '-- Each table', '-- Add other'] to omit any table. Table names here: The table structure information is ({database name: {schema name: [table name]}}): 
{'E_COMMERCE': {'E_COMMERCE': ['LEADS_QUALIFIED', 'GEOLOCATION', 'LEADS_CLOSED', 'ORDER_ITEMS', 'SELLERS', 'CUSTOMERS', 'ORDER_REVIEWS', 'PRODUCTS', 'PRODUCT_CATEGORY_NAME_TRANSLATION', 'ORDERS', 'ORDER_PAYMENTS']}}

When using ORDER BY xxx DESC, add NULLS LAST to exclude null records: ORDER BY xxx DESC NULLS LAST.
If the task description does not specify the number of decimal places, retain all decimals to four places.

[Self-refine]
2025-05-07 00:46:43 - Thread-3174 (execute) - INFO - [Try to run SQL in self-refine]
```sql
WITH "order_payments_total" AS (             -- total paid per order
    SELECT
        "order_id",
        SUM("payment_value") AS "order_payment_total"
    FROM E_COMMERCE.E_COMMERCE."ORDER_PAYMENTS"
    GROUP BY "order_id"
),
"customer_orders" AS (                       -- orders & basic sums per customer
    SELECT
        o."customer_id",
        COUNT(DISTINCT o."order_id")                         AS "number_orders",
        SUM(opt."order_payment_total")                       AS "total_payments",
        MIN(TO_TIMESTAMP_NTZ(o."order_purchase_timestamp"))  AS "first_purchase",
        MAX(TO_TIMESTAMP_NTZ(o."order_purchase_timestamp"))  AS "last_purchase"
    FROM E_COMMERCE.E_COMMERCE."ORDERS" o
    JOIN "order_payments_total" opt
          ON o."order_id" = opt."order_id"
    GROUP BY o."customer_id"
),
"customer_metrics" AS (                      -- final metrics
    SELECT
        "customer_id",
        "number_orders",
        "total_payments" / "number_orders"                                   AS "avg_payment_per_order",
        CASE
            WHEN DATEDIFF('day', "first_purchase", "last_purchase") < 7
                 THEN 1.0
            ELSE DATEDIFF('day', "first_purchase", "last_purchase") / 7.0
        END                                                                  AS "lifespan_weeks"
    FROM "customer_orders"
)
SELECT
    "customer_id",
    "number_orders"                     AS "number_of_orders",
    ROUND("avg_payment_per_order", 4)   AS "average_payment_per_order",
    ROUND("lifespan_weeks", 4)          AS "customer_lifespan_weeks"
FROM "customer_metrics"
ORDER BY "avg_payment_per_order" DESC NULLS LAST
LIMIT 3;
```
[Try to run SQL in self-refine]
2025-05-07 00:46:44 - Thread-3174 (execute) - INFO - Total iteration counts: 0
