WITH december_purchase_data AS (
    SELECT f.value::VARIANT:"item_name"::STRING AS "product_name", 
           f.value::VARIANT:"quantity"::NUMBER AS "quantity"
    FROM (
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201201"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201204"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201207"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201208"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201211"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201212"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201213"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201214"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201215"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201216"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201217"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201218"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201219"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201220"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201221"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201222"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201223"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201224"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201225"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201226"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201227"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201228"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201229"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201230"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201231"
    ) t,
    LATERAL FLATTEN(input => t."ITEMS") f
    WHERE f.value::VARIANT::STRING ILIKE '%Navy%Speckled%Tee%'
),
co_purchased_data AS (
    SELECT f.value::VARIANT:"item_name"::STRING AS "co_product_name", 
           SUM(f.value::VARIANT:"quantity"::NUMBER) AS "total_quantity"
    FROM (
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201201"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201204"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201207"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201208"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201211"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201212"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201213"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201214"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201215"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201216"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201217"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201218"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201219"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201220"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201221"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201222"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201223"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201224"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201225"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201226"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201227"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201228"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201229"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201230"
        UNION ALL
        SELECT * 
        FROM "GA4"."GA4_OBFUSCATED_SAMPLE_ECOMMERCE"."EVENTS_20201231"
    ) t,
    LATERAL FLATTEN(input => t."ITEMS") f
    WHERE f.value::VARIANT::STRING NOT ILIKE '%Navy%Speckled%Tee%'
    GROUP BY f.value::VARIANT:"item_name"::STRING
)
SELECT co_purchased_data."co_product_name", 
       co_purchased_data."total_quantity"
FROM co_purchased_data
ORDER BY co_purchased_data."total_quantity" DESC NULLS LAST
LIMIT 1;